<!doctype html>
<html lang="ko">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>쿠팡 재고 모니터 (최신 상태)</title>
<style>
  :root { --gap:12px; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 12px; }
  h1 { font-size: 20px; margin: 0 0 14px; }
  .controls { display: grid; grid-template-columns: repeat(auto-fit,minmax(160px,1fr)); gap: var(--gap); align-items: end; margin-bottom: 10px; }
  label { font-size: 12px; color: #555; display: block; margin-bottom: 4px; }
  input, select, button { width: 100%; padding: 8px 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
  button { cursor: pointer; }
  .row { display: flex; gap: var(--gap); align-items: center; margin: 10px 0 16px; }
  .muted { color:#666; font-size:12px; }
  table { width: 100%; border-collapse: collapse; }
  th, td { padding: 10px 10px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap; }
  th { background: #fafafa; position: sticky; top: 0; }
  td.status { font-weight: 600; }
</style>

<h1>쿠팡 재고 모니터 (최신 상태)</h1>

<div class="controls">
  <div>
    <label>SKU</label>
    <input id="sku" placeholder="예: 61841441">
  </div>
  <div>
    <label>옵션 ID</label>
    <input id="opt" placeholder="예: 92902832224">
  </div>
  <div>
    <label>최대 행 수</label>
    <select id="limit">
      <option>10</option><option selected>50</option><option>100</option><option>500</option>
    </select>
  </div>
  <div>
    <label>자동 새로고침(초)</label>
    <input id="refreshSec" type="number" min="0" value="0">
  </div>
  <div><button id="btn">조회</button></div>
</div>

<div class="row">
  <span id="msg" class="muted">준비됨</span>
  <span class="muted" id="lastLoaded"></span>
</div>

<table id="tbl">
  <thead>
    <tr>
      <th>SKU</th>
      <th>옵션 ID</th>
      <th>상태</th>
      <th>수량</th>
      <th>업데이트 시각</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// 프로젝트 URL과 anon 키 반영
const PROJECT_URL = "https://yzzsuwcvipvgueeuelfs.supabase.co";
const ANON_KEY    = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl6enN1d2N2aXB2Z3VlZXVlbGZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ5NTgyOTcsImV4cCI6MjA3MDUzNDI5N30.TVF7ziLIpyrDX0hhEa7GrrZAxmM4iH1LMsYcOYQuFFk";

// URL 파라미터 반영
const q = new URLSearchParams(location.search);
if (q.get("sku")) document.getElementById("sku").value = q.get("sku");
if (q.get("option")) document.getElementById("opt").value = q.get("option");

async function fetchLatest({ sku, option, limit=50 }) {
  const url = new URL(PROJECT_URL + "/rest/v1/coupang_stock_state");
  url.searchParams.set("select", "sku_id,option_id,last_status,last_qty,updated_at");
  if (sku)    url.searchParams.set("sku_id", `eq.${sku}`);
  if (option) url.searchParams.set("option_id", `eq.${option}`);
  url.searchParams.set("order", "updated_at.desc");
  url.searchParams.set("limit", String(limit));

  const res = await fetch(url, {
    headers: { apikey: ANON_KEY, Authorization: `Bearer ${ANON_KEY}` }
  });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.json();
}

function renderRows(rows){
  const tb = document.querySelector("#tbl tbody");
  tb.innerHTML = "";
  for (const r of rows){
    const tr = document.createElement("tr");
    const t = s => `<td>${s ?? ""}</td>`;
    tr.innerHTML = [
      t(r.sku_id),
      t(r.option_id),
      `<td class="status">${r.last_status ?? ""}</td>`,
      t(r.last_qty ?? ""),
      t(r.updated_at ? new Date(r.updated_at).toLocaleString() : "")
    ].join("");
    tb.appendChild(tr);
  }
}

let timer = null;
async function runOnce(){
  const sku = document.getElementById("sku").value.trim();
  const opt = document.getElementById("opt").value.trim();
  const limit = Number(document.getElementById("limit").value || 50);
  document.getElementById("msg").textContent = "불러오는 중...";
  try{
    const rows = await fetchLatest({ sku, option: opt, limit });
    renderRows(rows);
    document.getElementById("msg").textContent = `총 ${rows.length}건`;
    document.getElementById("lastLoaded").textContent = ` | 로드: ` + new Date().toLocaleTimeString();
    const url = new URL(location.href);
    if (sku) url.searchParams.set("sku", sku); else url.searchParams.delete("sku");
    if (opt) url.searchParams.set("option", opt); else url.searchParams.delete("option");
    history.replaceState(null, "", url);
  }catch(e){
    document.getElementById("msg").textContent = e.message;
  }
}

function applyAutoRefresh(){
  if (timer) { clearInterval(timer); timer = null; }
  const sec = Number(document.getElementById("refreshSec").value || 0);
  if (sec > 0) timer = setInterval(runOnce, sec * 1000);
}

document.getElementById("btn").onclick = () => { runOnce(); applyAutoRefresh(); };
document.getElementById("refreshSec").addEventListener("change", applyAutoRefresh);

runOnce();
</script>
</html>
